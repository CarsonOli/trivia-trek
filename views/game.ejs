<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Trivia Trek - Playing</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <main class="card">
      
      <div id="quiz-container">
        <div class="header-row">
          <span id="progress-text">Question 1/10</span>
          <span id="score-text">Score: 0</span>
        </div>
        
        <h2 id="question-text" class="question">Loading...</h2>
        
        <div id="answers-container" class="answers-grid">
          </div>

        <button id="next-btn" class="secondary-btn" style="display: none;">Next Question</button>
      </div>

      <div id="result-container" style="display: none;">
        <h1>Game Over!</h1>
        <p class="result-score">Final Score: <span id="final-score">0</span> / 10</p>
        <p id="rank-message" class="author"></p>
        <a href="/" class="button">Play Again</a>
      </div>

    </main>

    <script>
      const questions = <%- questions %>; 
      
      let currentQuestionIndex = 0;
      let score = 0;
      let isAnswered = false;

      const questionEl = document.getElementById("question-text");
      const answersEl = document.getElementById("answers-container");
      const nextBtn = document.getElementById("next-btn");
      const progressEl = document.getElementById("progress-text");
      const scoreEl = document.getElementById("score-text");

      // Decode HTML entities (e.g., &quot; -> ") from API
      function decodeHTML(html) {
        const txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
      }

      function loadQuestion() {
        isAnswered = false;
        nextBtn.style.display = "none";
        
        const currentQ = questions[currentQuestionIndex];
        questionEl.textContent = decodeHTML(currentQ.question);
        progressEl.textContent = `Question ${currentQuestionIndex + 1}/${questions.length}`;

        // Combine correct and incorrect answers and shuffle them
        const allAnswers = [...currentQ.incorrect_answers, currentQ.correct_answer];
        allAnswers.sort(() => Math.random() - 0.5);

        answersEl.innerHTML = ""; // Clear previous buttons

        allAnswers.forEach(ans => {
          const button = document.createElement("button");
          button.textContent = decodeHTML(ans);
          button.onclick = () => selectAnswer(button, ans, currentQ.correct_answer);
          answersEl.appendChild(button);
        });
      }

      function selectAnswer(selectedBtn, selectedText, correctText) {
        if (isAnswered) return; // Prevent duplicate submissions
        isAnswered = true;

        const isCorrect = selectedText === correctText;
        
        if (isCorrect) {
          selectedBtn.style.background = "#22c55e"; // Green
          selectedBtn.style.borderColor = "#22c55e";
          score++;
          scoreEl.textContent = `Score: ${score}`;
        } else {
          selectedBtn.style.background = "#ef4444"; // Red
          selectedBtn.style.borderColor = "#ef4444";
        }

        // Highlight the correct answer regardless
        Array.from(answersEl.children).forEach(btn => {
          if (btn.textContent === decodeHTML(correctText)) {
            btn.style.background = "#22c55e";
            btn.style.borderColor = "#22c55e";
          }
          btn.disabled = true; // Disable all buttons
        });

        // Show Next button or End Game
        if (currentQuestionIndex < questions.length - 1) {
          nextBtn.style.display = "inline-block";
        } else {
          setTimeout(showResults, 1500);
        }
      }

      nextBtn.onclick = () => {
        currentQuestionIndex++;
        loadQuestion();
      };

      function showResults() {
        document.getElementById("quiz-container").style.display = "none";
        document.getElementById("result-container").style.display = "block";
        document.getElementById("final-score").textContent = score;

        // Rank Logic
        const percentage = (score / questions.length) * 100;
        let rank = "Novice";
        if (percentage >= 80) rank = "Trivia Master";
        else if (percentage >= 50) rank = "Pro";
        
        document.getElementById("rank-message").textContent = `Rank: ${rank}`;
      }

      // Start the game
      loadQuestion();
    </script>
  </body>
</html>